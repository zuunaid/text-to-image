<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
  <style>
  @font-face {
    font-family: "EnglishFont";
    src: url("english.ttf") format("truetype");
    unicode-range: U+0000-024F; /* Basic Latin + extended Latin */
  }
  @font-face {
    font-family: "ArabicFont";
    src: url("arabic.ttf") format("truetype");
    unicode-range: U+0600-06FF, U+0750-077F, U+08A0-08FF; /* Arabic ranges */
  }
  @font-face {
    font-family: "BengaliFont";
    src: url("Kalpurush.ttf") format("truetype");
    unicode-range: U+0980-09FF; /* Bengali */
  }
  body {
    font-family: "EnglishFont", "ArabicFont", "BengaliFont", sans-serif;
  }
</style>
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>IG Text Image Maker — Per-Style Colors + Fonts + Stroke/Shadow</title>

<!-- Default output font: Noto Serif Bengali (Google Fonts) -->
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+Bengali:wght@400;700&display=swap" rel="stylesheet">

<style>
  :root{ --bg:#0b0f14; --panel:#0f1726; --ink:#e7edf3; --mut:#9fb2ca; --line:#1a2540; --focus:#5a8dff; --col:260px; }
  *{box-sizing:border-box}
  body{ margin:0; background:var(--bg); color:var(--ink);
        font:500 13px/1.35 system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans","Noto Sans Bengali",Arial,sans-serif; }
  header{ padding:14px 16px; border-bottom:1px solid var(--line); background:linear-gradient(180deg,rgba(255,255,255,.04),transparent); }
  h1{margin:0;font-size:15px}
  .tag{color:var(--mut);font-size:11px;margin-top:2px}
  .wrap{ padding:14px 16px 84px; max-width:1100px; margin:0 auto; }
  .panel{ background:rgba(15,23,38,.85); border:1px solid var(--line); border-radius:12px; backdrop-filter: blur(6px); }
  .section{padding:14px 14px 6px}
  .title{font-weight:700;font-size:12px;color:#cfe0ff;margin:0 0 8px}
  .grid{ display:grid; gap:10px; grid-template-columns:repeat(auto-fit,minmax(var(--col),1fr)); align-items:start; }
  .field{ display:grid; gap:6px; padding:10px; border:1px solid #18243e; border-radius:10px; background:rgba(12,18,30,.55); }
  .field.compact{padding:8px}
  label{font-size:11px;color:var(--mut)}
  input,select,textarea,button{
    width:100%; border:1px solid var(--line); background:#0b111a; color:#e7edf3;
    border-radius:8px; padding:8px 10px; font:500 13px/1.25 inherit; box-shadow: inset 0 1px 0 rgba(255,255,255,.04);
  }
  input[type="color"]{width:42px;height:34px;padding:0}
  textarea{min-height:120px;resize:vertical}
  input:focus,select:focus,textarea:focus{outline:none;border-color:var(--focus); box-shadow:0 0 0 2px rgba(90,141,255,.25)}
  .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .row > *{flex:1}
  .hint{color:var(--mut);font-size:11px}
  .controls{ padding:12px 14px; border-top:1px dashed #1b2a45; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .btn{cursor:pointer;border:none;border-radius:10px;padding:10px 14px;color:#eaf2ff;font-weight:700;font-size:13px;
       background:linear-gradient(180deg,#4e86ff,#2a66f0); border:1px solid #2a477a}
  .btn--subtle{background:#152030;color:#cfe0ff;border-color:#243a63}
  .status{margin-left:auto;padding:6px 10px;border:1px solid #2a477a;border-radius:999px;font-size:11px;color:#e9f2ff;
          background:linear-gradient(180deg,rgba(90,140,255,.18),rgba(60,110,220,.12))}
  .err{color:#ffbcbc;padding:10px 14px}
  .out{padding:12px 14px; display:grid; gap:10px}
  .thumb{background:rgba(11,17,26,.6); border:1px dashed #243555; border-radius:10px; padding:8px}
  .thumb img{width:100%;height:auto;border-radius:6px;background:#fff}
  .meta{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;font-size:11px;color:#e9f2ff;text-decoration:none;
        border-radius:999px;border:1px solid #2a477a; background:linear-gradient(180deg,rgba(90,140,255,.25),rgba(60,110,220,.15))}
  footer{ position:fixed;left:0;right:0;bottom:0;background:rgba(10,16,26,.92);
          border-top:1px solid var(--line); padding:8px 14px; color:#9fb2ca; font-size:11px; backdrop-filter: blur(6px); }
</style>
<style id="theme-premium-glass">
  /* ---- PREMIUM GLASS THEME (UI-only overrides) ---- */

  :root{
    /* slightly richer palette */
    --bg:#070b12;
    --panel:#0e1728;           /* base glass tint */
    --line:#1b2742;            /* glass border */
    --ink:#e9eef7;
    --mut:#9fb2ca;
    --focus:#6aa2ff;
    --col:260px;
    --glass-alpha: .66;        /* card translucency */
    --glass-alpha-strong: .78;
    --radius: 14px;
    --radius-sm: 10px;
    --radius-lg: 18px;
    --elev-1: 0 6px 18px rgba(0,0,0,.35);
    --elev-2: 0 10px 28px rgba(0,0,0,.45);
    --ring: 0 0 0 1px rgba(110,160,255,.35), 0 0 0 6px rgba(110,160,255,.12);
  }

  /* Background: layered gradients + subtle “noise” dither */
  body{
    color:var(--ink);
    background:
      radial-gradient(1200px 900px at 10% -10%, #12203b 0%, transparent 55%),
      radial-gradient(1300px 900px at 110% 20%, #1a2a4a 0%, transparent 60%),
      linear-gradient(180deg, #0a101a 0%, #0b111b 40%, #0a0f17 100%);
    background-attachment: fixed;
    -webkit-font-smoothing: antialiased;
    text-rendering: optimizeLegibility;
  }

  /* Header: thinner, glassier, with soft border + shine line */
  header{
    padding:12px 16px;
    border-bottom:1px solid rgba(120,150,200,.18);
    background:
      linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0) 60%),
      rgba(13,20,34,.55);
    backdrop-filter: blur(8px);
  }
  h1{ font-size:15px; letter-spacing:.2px; }
  .tag{ color:#b8c7de; }

  /* Panel: deep glass, rounded, inner highlight */
  .panel{
    background: rgba(14,23,40,var(--glass-alpha-strong));
    border:1px solid rgba(130,160,210,.18);
    border-radius: var(--radius-lg);
    box-shadow: var(--elev-1);
    backdrop-filter: blur(10px) saturate(115%);
  }

  .section{ padding:16px 16px 8px; }
  .title{
    color:#d6e4ff;
    letter-spacing:.25px;
    margin-bottom:10px;
    text-shadow: 0 1px 0 rgba(255,255,255,.06);
  }

  /* Grid spacing tighter, more premium rhythm */
  .grid{ gap:12px; }

  /* Field cards: floating glass tiles */
  .field{
    background: rgba(11,18,30,var(--glass-alpha));
    border:1px solid rgba(120,150,200,.16);
    border-radius: var(--radius);
    box-shadow:
      inset 0 1px 0 rgba(255,255,255,.04),
      0 8px 22px rgba(0,0,0,.28);
    transition: transform .15s ease, box-shadow .15s ease, border-color .2s ease, background .2s ease;
  }
  .field:hover{
    transform: translateY(-1px);
    box-shadow:
      inset 0 1px 0 rgba(255,255,255,.05),
      0 12px 28px rgba(0,0,0,.36);
    border-color: rgba(140,170,220,.24);
  }

  label{ color:#b6c7de; font-size:11px; }

  /* Inputs: soft glass, rounded, subtle inner glow */
  input,select,textarea,button{
    border-radius: 12px;
    border:1px solid rgba(120,150,200,.2);
    background: linear-gradient(180deg, rgba(15,22,34,.85), rgba(10,16,26,.85));
    color:#eaf1fe;
    box-shadow: inset 0 1px 0 rgba(255,255,255,.05);
    transition: border-color .2s ease, box-shadow .15s ease, background .2s ease, transform .05s ease;
  }
  input:focus,select:focus,textarea:focus{
    outline: none;
    border-color: rgba(110,160,255,.5);
    box-shadow: var(--ring);
    background: linear-gradient(180deg, rgba(16,24,38,.92), rgba(12,20,34,.92));
  }
  input:hover,select:hover,textarea:hover{
    border-color: rgba(140,170,220,.35);
  }
  input[type="color"]{
    border-radius: 10px;
    background: transparent;
    border-color: rgba(140,170,220,.35);
  }

  /* Buttons: premium gradient + glossy stripe */
  .btn{
    border-radius: 12px;
    font-weight: 800;
    letter-spacing:.2px;
    background:
      linear-gradient(180deg, rgba(110,170,255,.95), rgba(64,116,240,.95)),
      linear-gradient(180deg, rgba(255,255,255,.22), rgba(255,255,255,0) 40%);
    border:1px solid rgba(80,120,210,.8);
    box-shadow: 0 10px 20px rgba(60,110,220,.35), inset 0 1px 0 rgba(255,255,255,.25);
  }
  .btn:hover{
    transform: translateY(-1px);
    box-shadow: 0 14px 26px rgba(60,110,220,.45), inset 0 1px 0 rgba(255,255,255,.28);
  }
  .btn:active{ transform: translateY(0); }
  .btn--subtle{
    background:
      linear-gradient(180deg, rgba(22,30,50,.9), rgba(16,24,40,.9));
    border:1px solid rgba(120,150,200,.3);
    box-shadow: 0 6px 14px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.06);
    color:#d9e6ff;
  }
  .btn--subtle:hover{
    border-color: rgba(150,180,230,.45);
    transform: translateY(-1px);
  }

  /* Controls bar: slimmer glass strip */
  .controls{
    border-top:1px dashed rgba(120,150,200,.22);
    background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0));
  }
  .status{
    background: linear-gradient(180deg, rgba(80,130,240,.22), rgba(60,110,220,.14));
    border:1px solid rgba(70,110,190,.6);
    box-shadow: inset 0 1px 0 rgba(255,255,255,.12);
  }

  /* Output thumbs: framed glass gallery */
  .thumb{
    background: rgba(11,17,26,.55);
    border:1px solid rgba(130,160,210,.22);
    border-radius: 12px;
    padding:10px;
    box-shadow: 0 10px 26px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.05);
    backdrop-filter: blur(6px);
  }
  .thumb img{
    border-radius: 10px;
    box-shadow: 0 8px 24px rgba(0,0,0,.45);
  }

  .pill{
    border-radius: 999px;
    border:1px solid rgba(70,110,190,.6);
    background: linear-gradient(180deg, rgba(80,130,240,.22), rgba(60,110,220,.12));
    box-shadow: inset 0 1px 0 rgba(255,255,255,.12);
  }

  /* Footer: translucent dock */
  footer{
    background: rgba(8,12,20,.88);
    border-top: 1px solid rgba(120,150,200,.18);
    backdrop-filter: blur(8px) saturate(120%);
  }

  /* Tiny polish: checkboxes & selects */
  input[type="checkbox"]{ accent-color: #6aa2ff; }

  /* Scrollbar (WebKit) */
  *::-webkit-scrollbar{ height:10px; width:10px; }
  *::-webkit-scrollbar-thumb{
    background: linear-gradient(180deg, rgba(120,160,220,.45), rgba(100,140,210,.35));
    border: 2px solid rgba(10,16,26,.8);
    border-radius:12px;
  }
  *::-webkit-scrollbar-track{
    background: rgba(10,16,26,.6);
    border-radius:12px;
  }

  /* Compact wrap so UI wastes less space */
  .wrap{ padding-bottom: 76px; }

  /* Subtle error color */
  .err{ color:#ffc7c7; }

  /* Focus within field highlights the card */
  .field:focus-within{
    border-color: rgba(110,160,255,.5);
    box-shadow:
      inset 0 1px 0 rgba(255,255,255,.06),
      0 12px 28px rgba(0,0,0,.36),
      0 0 0 6px rgba(110,160,255,.12);
  }
</style>
</head>
<body>
<header>
  <h1>IG Text Image Maker</h1>
  <div class="tag">Per-style colors • per-style fonts • per-style stroke & shadow (auto-scale from base)</div>
</header>

<div class="wrap">
  <div class="panel">

    <!-- CONTENT -->
    <div class="section">
      <p class="title">Content</p>
      <div class="grid">
        <div class="field">
          <label for="textArea">Text</label>
          <div class="hint">*Title* • ~Subtitle~ • <b>#Heading#</b> (inline within a line).</div>
          <textarea id="textArea" placeholder="*শিরোনাম*\n~উপশিরোনাম~\nএটি সাধারণ অনুচ্ছেদ, যার মধ্যে আছে #ইনলাইন হেডিং#।"></textarea>
        </div>

        <div class="field compact">
          <label>Load .txt (UTF-8)</label>
          <div class="row"><input type="file" id="textFile" accept=".txt"><button class="btn btn--subtle" id="loadTxt" style="flex:0 0 auto">Load</button></div>
        </div>

        <div class="field compact">
          <label for="prefix">Output name (prefix)</label>
          <input id="prefix" value="story">
        </div>

        <div class="field compact">
          <label for="fontFile">Global custom font (optional .ttf/.otf)</label>
          <input type="file" id="fontFile" accept=".ttf,.otf">
          <div class="hint">Used everywhere unless a per-style font is uploaded.</div>
        </div>
      </div>
    </div>

    <!-- CANVAS & LAYOUT -->
    <div class="section">
      <p class="title">Canvas & Layout</p>
      <div class="grid">
        <div class="field compact">
          <label for="preset">Preset</label>
          <select id="preset">
            <option value="1080x1920" selected>1080×1920</option>
            <option value="1080x1350">1080×1350</option>
            <option value="custom">Custom…</option>
          </select>
        </div>
        <div class="field compact"><label for="w">Width</label><input id="w" type="number" value="1080" min="200"></div>
        <div class="field compact"><label for="h">Height</label><input id="h" type="number" value="1920" min="200"></div>

        <div class="field">
          <label>Margins (px)</label>
          <div class="row">
            <div class="row"><label for="mT" style="flex:0 0 72px">Top</label><input id="mT" type="number" value="100" min="0"></div>
            <div class="row"><label for="mR" style="flex:0 0 72px">Right</label><input id="mR" type="number" value="100" min="0"></div>
          </div>
          <div class="row">
            <div class="row"><label for="mB" style="flex:0 0 72px">Bottom</label><input id="mB" type="number" value="100" min="0"></div>
            <div class="row"><label for="mL" style="flex:0 0 72px">Left</label><input id="mL" type="number" value="100" min="0"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- TYPOGRAPHY (Global) -->
    <div class="section">
      <p class="title">Typography (Global)</p>
      <div class="grid">
        <div class="field">
          <label>Paragraph sizing</label>
          <div class="row">
            <div class="row"><label for="minSize" style="flex:0 0 90px">Min</label><input id="minSize" type="number" value="40" min="6"></div>
            <div class="row"><label for="maxSize" style="flex:0 0 90px">Max</label><input id="maxSize" type="number" value="180" min="10"></div>
          </div>
          <div class="row"><label for="fixedSize" style="flex:0 0 90px">Fixed</label><input id="fixedSize" type="number" placeholder="leave empty"></div>
          <div class="hint">Auto-fit chooses a base size between Min and Max — Fixed overrides.</div>
        </div>

        <div class="field compact">
          <label for="lineSpacing">Line spacing ×</label>
          <input id="lineSpacing" type="number" step="0.1" value="1.5" min="0.8">
        </div>

        <div class="field compact">
          <label for="align">Align</label>
          <select id="align"><option value="left">Left</option><option value="center" selected>Center</option><option value="right">Right</option></select>
        </div>

        <div class="field compact">
          <label for="fallbacks">Fallback fonts</label>
          <input id="fallbacks" value='"Noto Serif Bengali","Noto Sans Bengali","Noto Sans",serif'>
        </div>
      </div>
    </div>

    <!-- TITLES / SUBTITLES (with colors, per-style fonts, per-style stroke/shadow) -->
    <div class="section">
      <p class="title">Titles / Subtitles</p>
      <div class="grid">
        <!-- Title block -->
        <div class="field">
          <label>Title size</label>
          <div class="row">
            <select id="titleMode" style="flex:0 0 160px"><option value="mult" selected>Multiplier (×)</option><option value="px">Pixels (px)</option></select>
            <input id="titleMult" type="number" step="0.1" value="1.5" title="Title ×">
            <input id="titlePx" type="number" placeholder="e.g., 72" title="Title px">
          </div>
          <div class="row">
            <label style="flex:0 0 120px">Title color</label>
            <input type="color" id="titleColorPicker" value="#000000" style="flex:0 0 42px">
            <input id="titleColor" value="#000000" placeholder="#000000">
          </div>
          <div class="row">
            <label style="flex:0 0 160px">Title font (optional)</label>
            <input type="file" id="titleFontFile" accept=".ttf,.otf">
          </div>

          <div class="row"><label class="row"><input type="checkbox" id="titleStrokeToggle" style="flex:0 0 auto"> Custom stroke for Title</label></div>
          <div class="row">
            <label style="flex:0 0 120px">Stroke color</label>
            <input type="color" id="titleStrokePicker" value="#000000" style="flex:0 0 42px">
            <input id="titleStroke" value="" placeholder="leave blank = auto">
          </div>
          <div class="row"><label style="flex:0 0 120px">Stroke width (px)</label><input id="titleStrokeW" type="number" min="0" placeholder="auto"></div>

          <div class="row"><label class="row"><input type="checkbox" id="titleShadowToggle" style="flex:0 0 auto"> Custom shadow for Title</label></div>
          <div class="row"><label style="flex:0 0 110px">Opacity (0–1)</label><input id="titleShOp" type="number" step="0.05" min="0" max="1" placeholder="auto"></div>
          <div class="row"><label style="flex:0 0 110px">Blur (px)</label><input id="titleShBlur" type="number" min="0" placeholder="auto"></div>
          <div class="row"><label style="flex:0 0 110px">Distance (px)</label><input id="titleShDist" type="number" min="0" placeholder="auto"></div>
          <div class="row"><label style="flex:0 0 110px">Angle (deg)</label><input id="titleShAngle" type="number" placeholder="auto"></div>
        </div>

        <!-- Subtitle block -->
        <div class="field">
          <label>Subtitle size</label>
          <div class="row">
            <select id="subMode" style="flex:0 0 160px"><option value="mult" selected>Multiplier (×)</option><option value="px">Pixels (px)</option></select>
            <input id="subMult" type="number" step="0.1" value="1.35" title="Subtitle ×">
            <input id="subPx" type="number" placeholder="e.g., 56" title="Subtitle px">
          </div>
          <div class="row">
            <label style="flex:0 0 120px">Subtitle color</label>
            <input type="color" id="subColorPicker" value="#000000" style="flex:0 0 42px">
            <input id="subColor" value="#000000" placeholder="#000000">
          </div>
          <div class="row">
            <label style="flex:0 0 160px">Subtitle font (optional)</label>
            <input type="file" id="subFontFile" accept=".ttf,.otf">
          </div>

          <div class="row"><label class="row"><input type="checkbox" id="subStrokeToggle" style="flex:0 0 auto"> Custom stroke for Subtitle</label></div>
          <div class="row">
            <label style="flex:0 0 120px">Stroke color</label>
            <input type="color" id="subStrokePicker" value="#000000" style="flex:0 0 42px">
            <input id="subStroke" value="" placeholder="leave blank = auto">
          </div>
          <div class="row"><label style="flex:0 0 120px">Stroke width (px)</label><input id="subStrokeW" type="number" min="0" placeholder="auto"></div>

          <div class="row"><label class="row"><input type="checkbox" id="subShadowToggle" style="flex:0 0 auto"> Custom shadow for Subtitle</label></div>
          <div class="row"><label style="flex:0 0 110px">Opacity (0–1)</label><input id="subShOp" type="number" step="0.05" min="0" max="1" placeholder="auto"></div>
          <div class="row"><label style="flex:0 0 110px">Blur (px)</label><input id="subShBlur" type="number" min="0" placeholder="auto"></div>
          <div class="row"><label style="flex:0 0 110px">Distance (px)</label><input id="subShDist" type="number" min="0" placeholder="auto"></div>
          <div class="row"><label style="flex:0 0 110px">Angle (deg)</label><input id="subShAngle" type="number" placeholder="auto"></div>
        </div>
      </div>
      <div class="hint" style="padding:0 10px 10px">Leave per-style stroke/shadow fields blank to auto-scale from base settings.</div>
    </div>

    <!-- INLINE HEADING CONTROLS -->
    <div class="section">
      <p class="title">Inline Heading (#…#)</p>
      <div class="grid">
        <div class="field">
          <label>Heading size</label>
          <div class="row">
            <select id="headingMode" style="flex:0 0 160px"><option value="mult" selected>Multiplier (×)</option><option value="px">Pixels (px)</option></select>
            <input id="headingMult" type="number" step="0.1" value="1.1" title="Heading ×">
            <input id="headingPx" type="number" placeholder="e.g., 64" title="Heading px">
          </div>
        </div>

        <div class="field">
          <label>Heading color</label>
          <div class="row"><input type="color" id="headingColorPicker" value="#000000" style="flex:0 0 42px"><input id="headingColor" value="#000000" placeholder="#000000"></div>
        </div>

        <div class="field compact">
          <label class="row"><input type="checkbox" id="headingBold" style="flex:0 0 auto"> Bold heading</label>
          <div class="hint">Unchecked by default (normal weight for #…#).</div>
        </div>

        <div class="field compact">
          <label style="flex:0 0 160px">Heading font (optional)</label>
          <input type="file" id="headingFontFile" accept=".ttf,.otf">
        </div>

        <div class="field">
          <label class="row"><input type="checkbox" id="headStrokeToggle" style="flex:0 0 auto"> Custom stroke for Heading</label>
          <div class="row">
            <label style="flex:0 0 120px">Stroke color</label>
            <input type="color" id="headStrokePicker" value="#000000" style="flex:0 0 42px">
            <input id="headStroke" value="" placeholder="leave blank = auto">
          </div>
          <div class="row"><label style="flex:0 0 120px">Stroke width (px)</label><input id="headStrokeW" type="number" min="0" placeholder="auto"></div>

          <label class="row" style="margin-top:6px"><input type="checkbox" id="headShadowToggle" style="flex:0 0 auto"> Custom shadow for Heading</label>
          <div class="row"><label style="flex:0 0 110px">Opacity (0–1)</label><input id="headShOp" type="number" step="0.05" min="0" max="1" placeholder="auto"></div>
          <div class="row"><label style="flex:0 0 110px">Blur (px)</label><input id="headShBlur" type="number" min="0" placeholder="auto"></div>
          <div class="row"><label style="flex:0 0 110px">Distance (px)</label><input id="headShDist" type="number" min="0" placeholder="auto"></div>
          <div class="row"><label style="flex:0 0 110px">Angle (deg)</label><input id="headShAngle" type="number" placeholder="auto"></div>
        </div>
      </div>
    </div>

    <!-- COLORS / FORMAT -->
    <div class="section">
      <p class="title">Colors & Format</p>
      <div class="grid">
        <div class="field">
          <label>Background</label>
          <div class="row"><input type="color" id="bgPicker" value="#ffffff" style="flex:0 0 42px"><input id="bg" value="#ffffff" placeholder="#ffffff"></div>
        </div>

        <div class="field">
          <label>Foreground (paragraph text)</label>
          <div class="row"><input type="color" id="fgPicker" value="#000000" style="flex:0 0 42px"><input id="fg" value="#000000" placeholder="#000000"></div>
        </div>

        <div class="field">
          <label>Format</label>
          <div class="row">
            <select id="fmt">
              <option value="image/png" selected>PNG</option>
              <option value="image/jpeg">JPEG</option>
              <option value="image/webp">WEBP</option>
            </select>
          </div>
          <label class="row" style="margin-top:6px"><input type="checkbox" id="transparentBg" style="flex:0 0 auto"> Transparent BG (PNG only)</label>
        </div>
      </div>
    </div>

    <!-- GLOBAL STROKE / SHADOW / PAGE NUMBERS -->
    <div class="section">
      <p class="title">Base Stroke, Shadow & Page Numbers</p>
      <div class="grid">
        <div class="field">
          <label class="row"><input type="checkbox" id="strokeOn" style="flex:0 0 auto"> Enable base stroke</label>
          <div class="row">
            <label style="flex:0 0 120px">Stroke color</label>
            <input type="color" id="strokePicker" value="#000000" style="flex:0 0 42px">
            <input id="stroke" value="#000000" placeholder="#000000">
          </div>
          <div class="row"><label for="strokeW" style="flex:0 0 120px">Stroke width (px)</label><input id="strokeW" type="number" min="0" value="2"></div>
        </div>

        <div class="field">
          <label class="row"><input type="checkbox" id="useShadow" checked style="flex:0 0 auto"> Enable base shadow</label>
          <div class="row"><label for="shOp" style="flex:0 0 110px">Opacity (0–1)</label><input id="shOp" type="number" step="0.05" min="0" max="1" value="0.4"></div>
          <div class="row"><label for="shBlur" style="flex:0 0 110px">Blur (px)</label><input id="shBlur" type="number" min="0" value="12"></div>
          <div class="row"><label for="shDist" style="flex:0 0 110px">Distance (px)</label><input id="shDist" type="number" min="0" value="14"></div>
          <div class="row"><label for="shAngle" style="flex:0 0 110px">Angle (deg)</label><input id="shAngle" type="number" value="45"></div>
        </div>

        <div class="field">
          <label class="row"><input type="checkbox" id="pageNumbers" style="flex:0 0 auto"> Add page numbers</label>
          <div class="row"><label for="pnSize" style="flex:0 0 150px">Page number size (px)</label><input id="pnSize" type="number" min="8" value="24"></div>
          <div class="hint">Small grey number centered at the bottom.</div>
        </div>
      </div>
    </div>

    <!-- ACTIONS / OUTPUT -->
    <div class="controls">
      <button class="btn" id="generate">Generate Images</button>
      <button class="btn btn--subtle" id="clearOut">Clear Output</button>
      <span class="status" id="status">Ready</span>
    </div>

    <div class="out" id="output"></div>
    <div class="err" id="errorBox"></div>
  </div>
</div>

<footer>
  Tip: Use <b>*Title*</b>, <b>~Subtitle~</b>, and inline <b>#Heading#</b> anywhere in a sentence.
</footer>

<script>
const $ = s=>document.querySelector(s);
document.getElementById('align').value = 'left';
const out=$('#output'), status=$('#status'), errorBox=$('#errorBox');
function setStatus(m){status.textContent=m} function showError(m){errorBox.textContent=m}

/* Default Google font ready */

    if (document.fonts.check(`12px "${DEFAULT_GOOGLE_FONT}"`)) return true;
    await document.fonts.load(`400 24px "${DEFAULT_GOOGLE_FONT}"`);
    await document.fonts.load(`700 24px "${DEFAULT_GOOGLE_FONT}"`);
    await document.fonts.ready;
    return document.fonts.check(`12px "${DEFAULT_GOOGLE_FONT}"`);
  }catch(e){ console.warn('Default font wait failed:', e); return false; }
}

/* Color picker ↔ text hex sync */
function bindColorSync(p, t){
  const pick=$(p), txt=$(t);
  pick.addEventListener('input', ()=> txt.value = pick.value);
  txt.addEventListener('input', ()=>{
    const v = txt.value.trim();
    if(/^#?[0-9a-fA-F]{3,8}$/.test(v)){ pick.value = v.startsWith('#')? v : ('#'+v); }
  });
}
bindColorSync('#bgPicker','#bg'); bindColorSync('#fgPicker','#fg');
bindColorSync('#strokePicker','#stroke'); bindColorSync('#headingColorPicker','#headingColor');
bindColorSync('#titleColorPicker','#titleColor'); bindColorSync('#subColorPicker','#subColor');

/* Preset sizes */
$('#preset').addEventListener('change',e=>{
  const v=e.target.value;
  if(v==='1080x1920'){$('#w').value=1080;$('#h').value=1920}
  else if(v==='1080x1350'){$('#w').value=1080;$('#h').value=1350}
});

/* Load .txt */
$('#loadTxt').addEventListener('click', async ()=>{
  try{
    const f=$('#textFile').files?.[0];
    if(!f){ alert('Choose a .txt file first.'); return; }
    $('#textArea').value = await f.text();
  }catch(e){ showError('Could not read text file: '+e.message); }
});

/* Clear output */
$('#clearOut').addEventListener('click', ()=>{ out.innerHTML=''; setStatus('Cleared'); showError(''); });

/* Font loaders */
async function tryLoadFont(file, name){
  if(!file) return false;
  try{
    const url=URL.createObjectURL(file);
    const ff=new FontFace(name,`url(${url})`);
    await ff.load(); document.fonts.add(ff);
    await document.fonts.ready;
    return true;
  }catch(e){ showError(`${name} load failed: `+e.message); return false; }
}

/* ---------- Parsing ---------- */
function parseTextToParagraphs(text){
  const lines=(text||'').replace(/\r\n/g,'\n').split('\n');
  const paras=[];
  for(const raw of lines){
    const trimmed=raw.trim();
    if(!trimmed){ paras.push({type:'blank'}); continue; }

    if(trimmed.startsWith('*') && trimmed.endsWith('*') && trimmed.length>=2){
      paras.push({type:'title', text:trimmed.slice(1,-1).trim()}); continue;
    }
    if(trimmed.startsWith('~') && trimmed.endsWith('~') && trimmed.length>=2){
      paras.push({type:'subtitle', text:trimmed.slice(1,-1).trim()}); continue;
    }

    const segs=[]; let last=0; const re=/#([^#]+)#/g; let m;
    while((m=re.exec(raw))!==null){
      const before=raw.slice(last, m.index);
      if(before) segs.push({kind:'normal', text:before});
      segs.push({kind:'heading', text:m[1]});
      last=re.lastIndex;
    }
    const after=raw.slice(last);
    if(after) segs.push({kind:'normal', text:after});
    if(segs.length===0) segs.push({kind:'normal', text:raw});

    paras.push({type:'text', segs});
  }
  return paras;
}

/* Canvas helpers */
function makeCtx(w,h){ const c=document.createElement('canvas'); c.width=w; c.height=h; return {canvas:c, ctx:c.getContext('2d')}; }
function setFont(ctx,size,fontOrder,weight='400'){
  ctx.font=`${weight} ${size}px ${fontOrder}`; ctx.textBaseline='top'; ctx.textAlign='left';
}
function lineHeight(ctx,size,ls){
  const m=ctx.measureText('বাংলা Ag'); const a=m.actualBoundingBoxAscent??size*0.8; const d=m.actualBoundingBoxDescent??size*0.2;
  return Math.max(1, Math.round((a+d)*ls));
}

/* Font order builder */
function familyOrder({perStyle, globalUser, fallbacks}){
  const parts=[];
  if(perStyle) parts.push(`"${perStyle}"`);
  if(globalUser) parts.push(`"${globalUser}"`);
  parts.push(`"${DEFAULT_GOOGLE_FONT}"`);
  parts.push(fallbacks);
  return parts.join(', ');
}

/* Sizes */
function sizeFor(kind, base){
  const titleMode=$('#titleMode').value, subMode=$('#subMode').value, headMode=$('#headingMode').value;
  const titleMult=Math.max(0.1, parseFloat($('#titleMult').value||'1.5'));
  const subMult=Math.max(0.1, parseFloat($('#subMult').value||'1.35'));
  const headMult=Math.max(0.1, parseFloat($('#headingMult').value||'1.1'));
  const titlePx=parseInt($('#titlePx').value||'0',10);
  const subPx=parseInt($('#subPx').value||'0',10);
  const headPx=parseInt($('#headingPx').value||'0',10);
  if(kind==='title') return (titleMode==='px' && titlePx>0) ? titlePx : Math.round(base*titleMult);
  if(kind==='subtitle') return (subMode==='px' && subPx>0) ? subPx : Math.round(base*subMult);
  if(kind==='heading') return (headMode==='px' && headPx>0) ? headPx : Math.round(base*headMult);
  return base;
}

/* Read number or null if blank */
function numOrNull(el){ const v=(el?.value??'').trim(); if(v==='') return null; const n=Number(v); return Number.isFinite(n)? n : null; }

/* Build per-style stroke/shadow using auto-scaling when blanks */
function resolveStrokeShadow(base, runSize, baseStroke, baseShadow, opts){
  const ratio = Math.max(0.01, runSize / base);
  // STROKE
  let useStroke = baseStroke.on;
  let strokeColor = baseStroke.color;
  let strokeWidth = baseStroke.width;
  if(opts.strokeToggle){
    useStroke = true;
    if(opts.strokeColor) strokeColor = opts.strokeColor;
    const w = opts.strokeW;
    strokeWidth = (w==null) ? (baseStroke.width * ratio) : w;
  }
  // SHADOW
  let useShadow = baseShadow.enabled;
  let shOpacity = baseShadow.opacity;
  let shBlur = baseShadow.blur;
  let shDist = baseShadow.distance;
  let shAngle = baseShadow.angle;
  if(opts.shadowToggle){
    useShadow = true;
    shOpacity = (opts.shOp==null) ? baseShadow.opacity : opts.shOp;
    shBlur    = (opts.shBlur==null) ? Math.round(baseShadow.blur * ratio) : opts.shBlur;
    shDist    = (opts.shDist==null) ? Math.round(baseShadow.distance * ratio) : opts.shDist;
    shAngle   = (opts.shAngle==null) ? baseShadow.angle : opts.shAngle;
  }
  return {
    stroke: { on: useStroke, color: strokeColor, width: Math.max(0, strokeWidth) },
    shadow: { enabled: useShadow, opacity: Math.max(0, Math.min(1, shOpacity)), blur: Math.max(0, shBlur), distance: Math.max(0, shDist), angle: shAngle }
  };
}

/* Tokenize keeping spaces */
function tokensFor(text){ return text.split(/(\s+)/).filter(t=>t.length>0); }

/* Layout paragraph (normal + inline headings) */
function layoutMixedParagraph(segs, base, ls, maxW, fonts, colors, headingBold, styleOpts){
  const lines=[]; let currentRuns=[]; let curWidth=0; let curH=0;
  const {ctx}=makeCtx(10,10);

  function measure(text,size,weight,fontOrder){
    setFont(ctx,size,fontOrder,weight);
    return {w: ctx.measureText(text).width, h: lineHeight(ctx,size,ls)};
  }
  function pushRun(runW, runH, run){
    currentRuns.push(run); curWidth += runW; curH = Math.max(curH, runH);
  }
  function newLine(){
    lines.push({runs:currentRuns, lineH: curH||lineHeight(ctx,base,ls), width:curWidth});
    currentRuns=[]; curWidth=0; curH=0;
  }

  for(const seg of segs){
    const isHeading = (seg.kind==='heading');
    const size=sizeFor(isHeading?'heading':'normal', base);
    const weight = isHeading && headingBold ? '700' : '400';
    const color = isHeading ? colors.heading : colors.fg;
    const fontOrder = familyOrder({
      perStyle: isHeading ? fonts.per.heading : null,
      globalUser: fonts.globalUser,
      fallbacks: fonts.fallbacks
    });

    // per-style stroke/shadow (heading)
    const ss = resolveStrokeShadow(
      base, size,
      styleOpts.baseStroke, styleOpts.baseShadow,
      isHeading ? styleOpts.head : {strokeToggle:false, shadowToggle:false}
    );

    for(const tok of tokensFor(seg.text)){
      const {w,h}=measure(tok,size,weight,fontOrder);
      if(curWidth>0 && curWidth + w > maxW){
        if(tok.trim()===''){ continue; }
        newLine();
      }
      pushRun(w,h,{text:tok,size,weight,color,fontOrder,stroke:ss.stroke,shadow:ss.shadow});
    }
  }
  if(currentRuns.length>0 || lines.length===0){ newLine(); }
  return lines;
}

/* Build all lines */
function buildAllLines(paras, base, ls, align, fonts, maxW, colors, headingBold, styleOpts){
  const lines=[];
  for(const p of paras){
    if(p.type==='blank'){
      const {ctx}=makeCtx(10,10);
      const h=lineHeight(ctx,base,ls);
      const fontOrder = familyOrder({perStyle:null, globalUser:fonts.globalUser, fallbacks:fonts.fallbacks});
      const ss = resolveStrokeShadow(base, base, styleOpts.baseStroke, styleOpts.baseShadow, {strokeToggle:false, shadowToggle:false});
      lines.push({runs:[{text:'',size:base,weight:'400',color:colors.fg,fontOrder,stroke:ss.stroke,shadow:ss.shadow}], lineH:h, width:0});
      continue;
    }
    if(p.type==='title' || p.type==='subtitle'){
      const sz=sizeFor(p.type, base);
      const weight='700';
      const color=(p.type==='title')?colors.title:colors.subtitle;
      const perStyle = (p.type==='title') ? fonts.per.title : fonts.per.subtitle;
      const fontOrder = familyOrder({perStyle, globalUser:fonts.globalUser, fallbacks:fonts.fallbacks});
      const {ctx}=makeCtx(10,10);
      setFont(ctx,sz,fontOrder,weight);

      // per-style stroke/shadow (title/subtitle)
      const ss = resolveStrokeShadow(
        base, sz,
        styleOpts.baseStroke, styleOpts.baseShadow,
        p.type==='title' ? styleOpts.title : styleOpts.subtitle
      );

      const words=tokensFor(p.text);
      const linesLocal=[]; let lineText=''; let width=0; let h=0;
      for(const t of words){
        const w=ctx.measureText(lineText+t).width;
        if(lineText && w>maxW){ linesLocal.push({text:lineText, width, h}); lineText=t; width=ctx.measureText(t).width; h=lineHeight(ctx,sz,ls); }
        else{ lineText+=t; width=ctx.measureText(lineText).width; h=Math.max(h,lineHeight(ctx,sz,ls)); }
      }
      if(lineText) linesLocal.push({text:lineText, width, h});
      for(const L of linesLocal){
        lines.push({runs:[{text:L.text,size:sz,weight,color,fontOrder,stroke:ss.stroke,shadow:ss.shadow}], lineH:L.h, width:L.width});
      }
      continue;
    }
    const lm = layoutMixedParagraph(p.segs, base, ls, maxW, fonts, colors, headingBold, styleOpts);
    lines.push(...lm);
  }
  return lines;
}

function paginate(lines, boxH){
  const pages=[]; let cur=[], used=0;
  for(const ln of lines){
    if(used + ln.lineH > boxH && cur.length>0){ pages.push(cur); cur=[ln]; used=ln.lineH; }
    else { cur.push(ln); used+=ln.lineH; }
  }
  if(cur.length) pages.push(cur);
  return pages;
}

/* Draw page (per-run stroke & shadow) */
function drawPage(W,H,bg,margins,lines,align,pageNum,pnSize){
  const {canvas,ctx}=makeCtx(W,H);
  const fmt=$('#fmt').value, transparent=$('#transparentBg').checked && fmt==='image/png';
  if(!transparent){ ctx.fillStyle=bg; ctx.fillRect(0,0,W,H); } else ctx.clearRect(0,0,W,H);

  const textW=W - margins.left - margins.right;
  const textH=H - margins.top - margins.bottom;
  let totalH=0; for(const l of lines) totalH+=l.lineH;
  let y = margins.top + Math.max(0, Math.floor((textH - totalH)/2));

  for(const ln of lines){
    let startX = margins.left;
    if(align==='center') startX = Math.floor((W - ln.width)/2);
    else if(align==='right') startX = W - margins.right - ln.width;

    let x = startX;
    for(const run of ln.runs){
      // Shadow per run
      if(run.shadow?.enabled){
        const rad=(run.shadow.angle*Math.PI)/180;
        ctx.shadowColor=`rgba(0,0,0,${run.shadow.opacity})`; ctx.shadowBlur=run.shadow.blur;
        ctx.shadowOffsetX=Math.round(Math.cos(rad)*run.shadow.distance);
        ctx.shadowOffsetY=Math.round(Math.sin(rad)*run.shadow.distance);
      } else {
        ctx.shadowColor='transparent'; ctx.shadowBlur=0; ctx.shadowOffsetX=0; ctx.shadowOffsetY=0;
      }

      ctx.font=`${run.weight} ${run.size}px ${run.fontOrder}`;
      ctx.textBaseline='top'; ctx.textAlign='left';

      if(run.stroke?.on && run.stroke.width>0){
        ctx.save(); ctx.lineJoin='round'; ctx.miterLimit=2;
        ctx.lineWidth=run.stroke.width; ctx.strokeStyle=run.stroke.color; ctx.strokeText(run.text, x, y); ctx.restore();
      }
      ctx.fillStyle = run.color;
      ctx.fillText(run.text, x, y);

      x += ctx.measureText(run.text).width;
    }
    y += ln.lineH;
  }

  if(pageNum!=null){
    ctx.save(); ctx.shadowColor='transparent'; ctx.fillStyle='#8a8a8a';
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.font=`400 ${Math.max(8, parseInt(pnSize||'16',10))}px "${DEFAULT_GOOGLE_FONT}", ${$('#fallbacks').value}`;
    const pnY=Math.floor(H - margins.bottom/2);
    ctx.fillText(String(pageNum), Math.floor(W/2), pnY);
    ctx.restore();
  }
  return canvas;
}

/* ---------- Generate ---------- */
$('#generate').addEventListener('click', async ()=>{
  try{
    showError(''); setStatus('Loading fonts…');

    await ensureDefaultGoogleFont();

    // global & per-style fonts
    const globalLoaded = await tryLoadFont($('#fontFile').files?.[0]||null, 'UserFont');
    const titleLoaded  = await tryLoadFont($('#titleFontFile').files?.[0]||null, 'TitleFont');
    const subLoaded    = await tryLoadFont($('#subFontFile').files?.[0]||null, 'SubtitleFont');
    const headLoaded   = await tryLoadFont($('#headingFontFile').files?.[0]||null, 'HeadingFont');

    const fonts = {
       globalUser: globalLoaded ? 'UserFont' : null,
       per: {
       title:   titleLoaded ? 'TitleFont' : null,
       subtitle:subLoaded   ? 'SubtitleFont' : null,
       heading: headLoaded  ? 'HeadingFont' : null
     },
    fallbacks: '"EnglishFont","ArabicFont","BengaliFont",sans-serif'
  };

    setStatus('Preparing…');
    let W=parseInt($('#w').value||'1080',10), H=parseInt($('#h').value||'1920',10);
    const preset=$('#preset').value;
    if(preset!=='custom'){ const [pw,ph]=preset.split('x').map(n=>parseInt(n,10)); W=pw; H=ph; $('#w').value=W; $('#h').value=H; }

    const margins={
      top:Math.max(0, parseInt($('#mT').value||'100',10)),
      right:Math.max(0, parseInt($('#mR').value||'100',10)),
      bottom:Math.max(0, parseInt($('#mB').value||'100',10)),
      left:Math.max(0, parseInt($('#mL').value||'100',10))
    };
    const lineSpacing=Math.max(0.8, parseFloat($('#lineSpacing').value||'1.5'));
    const align=$('#align').value;
    const minSize=Math.max(6, parseInt($('#minSize').value||'40',10));
    const maxSize=Math.max(minSize, parseInt($('#maxSize').value||'180',10));
    const fixedSizeVal=$('#fixedSize').value.trim(); const fixedSize=fixedSizeVal? Math.max(6, parseInt(fixedSizeVal,10)) : null;

    const bg=($('#bg').value||'#ffffff');
    const fg=($('#fg').value||'#000000');
    const colors={
      fg,
      heading: ($('#headingColor').value||'#000000'),
      title:   ($('#titleColor').value||'#000000'),
      subtitle:($('#subColor').value||'#000000')
    };

    // Base stroke & shadow
    const baseStroke={ on:$('#strokeOn').checked, color:($('#stroke').value||'#000000'),
                       width:Math.max(0, parseFloat($('#strokeW').value||'2')) };
    const baseShadow={ enabled:$('#useShadow').checked,
                       opacity:Math.min(1,Math.max(0,parseFloat($('#shOp').value||'0.4'))),
                       blur:Math.max(0, parseInt($('#shBlur').value||'12',10)),
                       distance:Math.max(0, parseInt($('#shDist').value||'14',10)),
                       angle:parseFloat($('#shAngle').value||'45') };

    // Per-style stroke/shadow options (blank = auto)
    const styleOpts = {
      baseStroke, baseShadow,
      title:{
        strokeToggle: $('#titleStrokeToggle').checked,
        strokeColor: ($('#titleStroke').value||'').trim() || null,
        strokeW: numOrNull($('#titleStrokeW')),
        shadowToggle: $('#titleShadowToggle').checked,
        shOp:   numOrNull($('#titleShOp')),
        shBlur: numOrNull($('#titleShBlur')),
        shDist: numOrNull($('#titleShDist')),
        shAngle:numOrNull($('#titleShAngle'))
      },
      subtitle:{
        strokeToggle: $('#subStrokeToggle').checked,
        strokeColor: ($('#subStroke').value||'').trim() || null,
        strokeW: numOrNull($('#subStrokeW')),
        shadowToggle: $('#subShadowToggle').checked,
        shOp:   numOrNull($('#subShOp')),
        shBlur: numOrNull($('#subShBlur')),
        shDist: numOrNull($('#subShDist')),
        shAngle:numOrNull($('#subShAngle'))
      },
      head:{
        strokeToggle: $('#headStrokeToggle').checked,
        strokeColor: ($('#headStroke').value||'').trim() || null,
        strokeW: numOrNull($('#headStrokeW')),
        shadowToggle: $('#headShadowToggle').checked,
        shOp:   numOrNull($('#headShOp')),
        shBlur: numOrNull($('#headShBlur')),
        shDist: numOrNull($('#headShDist')),
        shAngle:numOrNull($('#headShAngle'))
      }
    };

    const headingBold  = $('#headingBold').checked;
    const addPageNums=$('#pageNumbers').checked;
    const pnSize=Math.max(8, parseInt($('#pnSize').value||'24',10));
    const prefix=($('#prefix').value||'story').trim().replace(/\s+/g,'_');

    let text=$('#textArea').value;
    if(!text && $('#textFile').files?.[0]) text = await $('#textFile').files[0].text();
    if(!text) text='*শিরোনাম উদাহরণ*\n~উপশিরোনাম উদাহরণ~\nএটি সাধারণ অনুচ্ছেদ, যার মধ্যে আছে #ইনলাইন হেডিং# — per-style stroke/shadow auto-scales from base.';

    out.innerHTML='';

    const textW=W - margins.left - margins.right;
    const textH=H - margins.top - margins.bottom;
    const paras=parseTextToParagraphs(text);

    const {ctx}=makeCtx(10,10);
    function totalHeight(lines){ let s=0; for(const l of lines) s+=l.lineH; return s; }

    const fmt=$('#fmt').value; const ext = (fmt.includes('jpeg')?'jpg':(fmt.includes('png')?'png':'webp'));

    function build(base){
      return buildAllLines(paras, base, lineSpacing, align, fonts, textW, colors, headingBold, styleOpts);
    }

    if(fixedSize){
      setStatus(`Rendering (fixed ${fixedSize}px)…`);
      const lines = build(fixedSize);
      const pages = paginate(lines, textH);
      pages.forEach((chunk, idx)=>{
        const cnv=drawPage(W,H,bg,margins,chunk,align, addPageNums?(idx+1):null, pnSize);
        const filename=`${prefix}_${String(idx+1).padStart(3,'0')}.${ext}`;
        const fig=document.createElement('div'); fig.className='thumb';
        const im=new Image(); im.src=cnv.toDataURL(fmt,1.0);
        const meta=document.createElement('div'); meta.className='meta';
        const a=document.createElement('a'); a.textContent='Download'; a.href=im.src; a.download=filename; a.className='pill';
        const span=document.createElement('span'); span.className='hint'; span.textContent=`${idx+1} / ${pages.length}`;
        fig.appendChild(im); meta.appendChild(a); meta.appendChild(span); fig.appendChild(meta); out.appendChild(fig);
      });
      setStatus(`Done (${pages.length} page${pages.length>1?'s':''})`);
      return;
    }

    // Auto-fit to one page if possible
    setStatus('Fitting…');
    let lo=minSize, hi=maxSize, best=null;
    function fits(base){ const L=build(base); return {ok: totalHeight(L) <= textH, lines:L, base}; }

    const tMin=fits(minSize);
    if(tMin.ok){
      while(lo<=hi){
        const mid=(lo+hi)>>1;
        const r=fits(mid);
        if(r.ok){ best=r; lo=mid+1; } else hi=mid-1;
      }
      setStatus(`Rendering (single page @ ${best.base}px)…`);
      const cnv=drawPage(W,H,bg,margins,best.lines,align, addPageNums?1:null, pnSize);
      const filename=`${prefix}.${ext}`;
      const fig=document.createElement('div'); fig.className='thumb';
      const im=new Image(); im.src=cnv.toDataURL(fmt,1.0);
      const meta=document.createElement('div'); meta.className='meta';
      const a=document.createElement('a'); a.textContent='Download'; a.href=im.src; a.download=filename; a.className='pill';
      const span=document.createElement('span'); span.className='hint'; span.textContent=`1 / 1`;
      fig.appendChild(im); meta.appendChild(a); meta.appendChild(span); fig.appendChild(meta); out.appendChild(fig);
      setStatus('Done');
    } else {
      setStatus(`Paginating @ ${minSize}px…`);
      const L=build(minSize), pages=paginate(L, textH);
      pages.forEach((chunk, idx)=>{
        const cnv=drawPage(W,H,bg,margins,chunk,align, addPageNums?(idx+1):null, pnSize);
        const filename=`${prefix}_${String(idx+1).padStart(3,'0')}.${ext}`;
        const fig=document.createElement('div'); fig.className='thumb';
        const im=new Image(); im.src=cnv.toDataURL(fmt,1.0);
        const meta=document.createElement('div'); meta.className='meta';
        const a=document.createElement('a'); a.textContent='Download'; a.href=im.src; a.download=filename; a.className='pill';
        const span=document.createElement('span'); span.className='hint'; span.textContent=`${idx+1} / ${pages.length}`;
        fig.appendChild(im); meta.appendChild(a); meta.appendChild(span); fig.appendChild(meta); out.appendChild(fig);
      });
      setStatus(`Done (${pages.length} pages)`);
    }
  }catch(err){ console.error(err); showError(err?.message||String(err)); setStatus('Error'); }
});
</script>
</body>
</html>

